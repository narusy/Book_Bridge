import pandas as pd
import streamlit as st
from pathlib import Path

st.set_page_config(page_title="ë„ì„œ ì¶”ì²œ í”„ë¡œê·¸ë¨", layout="wide")
st.title("## ë„ì„œ ì¶”ì²œ í”„ë¡œê·¸ë¨ ##")

# -----------------------------
# CSV íŒŒì¼ ì¤€ë¹„
# -----------------------------
csv_path = Path(__file__).parent / "2-2í”„ë´‰_ë„ì„œëª©ë¡.csv"

# í•­ìƒ ê¸°ë³¸ CSV ì‚¬ìš©
df = pd.read_csv(csv_path, encoding='cp949')

# ì»¬ëŸ¼ ì´ë¦„ ê³µë°± ì œê±°
df.columns = [c.strip() for c in df.columns]

# -----------------------------
# ë¶„ì•¼ ì„ íƒ
# -----------------------------
ë¶„ì•¼ = st.selectbox(
    "ë¶„ì•¼ë¥¼ ì„ íƒí•˜ì„¸ìš”",
    ["ì¸ë¬¸", "ì‚¬íšŒ", "ìì—°", "ê³µí•™", "ì˜ì•½", "ì˜ˆì²´ëŠ¥"]
)

ì§„ë¡œ_ë¶„ë¥˜ = {
    "ì¸ë¬¸": ["ì „ì²´ë³´ê¸°", "ì¸ë¬¸", "êµ­ì–´", "ì˜ì–´", "ë¬¸í•™", "ì—­ì‚¬", "ë¯¸ë””ì–´", "ìƒë‹´ì‹¬ë¦¬", "ë„ë•"],
    "ì‚¬íšŒ": ["ì „ì²´ë³´ê¸°", "ì‚¬íšŒ", "ê²½ì˜", "ê²½ì œ", "êµìœ¡"],
    "ìì—°": ["ì „ì²´ë³´ê¸°", "ê³¼í•™", "ìˆ˜í•™", "í™˜ê²½", "ìƒëª…"],
    "ê³µí•™": ["ì „ì²´ë³´ê¸°", "ê±´ì¶•", "ê¸°ê³„ê³µí•™", "ë¡œë´‡ê³µí•™", "ì»´í“¨í„°ê³µí•™", "ì†Œí”„íŠ¸ì›¨ì–´ê³µí•™", "ì „ê¸°ì „ìê³µí•™", "í™”í•™ê³µí•™", "ê³¼í•™ê¸°ìˆ "],
    "ì˜ì•½": ["ì „ì²´ë³´ê¸°", "ì˜í•™_ì˜ì˜ˆ", "ì˜í•™_ì¹˜ì˜ì˜ˆ", "ì˜í•™_ìˆ˜ì˜ì˜ˆ", "ì•½í•™", "ê°„í˜¸"],
    "ì˜ˆì²´ëŠ¥": ["ì „ì²´ë³´ê¸°", "ë¯¸ìˆ ", "ìŒì•…", "ì²´ìœ¡"]
}

ì§„ë¡œ = st.selectbox("ì„¸ë¶€ ì§„ë¡œë¥¼ ì„ íƒí•˜ì„¸ìš”", ì§„ë¡œ_ë¶„ë¥˜[ë¶„ì•¼])

# -----------------------------
# ê²€ìƒ‰ ê¸°ëŠ¥
# -----------------------------
search_keyword = st.text_input("ğŸ” ì±… ì œëª© ë˜ëŠ” ì €ì ê²€ìƒ‰")

# -----------------------------
# ë°ì´í„° í•„í„°ë§
# -----------------------------
filtered = df.copy()

# ë¶„ì•¼ í•„í„°
if ì§„ë¡œ != "ì „ì²´ë³´ê¸°":
    filtered = filtered[filtered['ì§„ë¡œ'].astype(str).str.strip() == ì§„ë¡œ]
else:
    filtered = filtered[filtered['ë¶„ì•¼'].astype(str).str.strip() == ë¶„ì•¼]

# ê²€ìƒ‰ í•„í„°
if search_keyword:
    # ì œëª© ë˜ëŠ” ì €ìì— í‚¤ì›Œë“œ í¬í•¨ ì—¬ë¶€
    filtered = filtered[
        filtered.apply(
            lambda x: search_keyword.lower() in str(x.get('ì œëª©','')).lower()
            or search_keyword.lower() in str(x.get('ì €ì','')).lower(),
            axis=1
        )
    ]

# -----------------------------
# ê²°ê³¼ í‘œì‹œ
# -----------------------------
st.markdown(f"### ê²°ê³¼: {len(filtered)}ê±´")
st.dataframe(filtered, use_container_width=True)

# -----------------------------
# CSV ë‹¤ìš´ë¡œë“œ
# -----------------------------
def convert_df(df_in):
    return df_in.to_csv(index=False).encode('utf-8-sig')

csv_bytes = convert_df(filtered)
st.download_button("ê²°ê³¼ CSV ë‹¤ìš´ë¡œë“œ", csv_bytes, file_name="ì¶”ì²œ_ë„ì„œ.csv", mime="text/csv")
